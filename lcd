#include <LiquidCrystal_I2C.h>

const char itemGift = 0;   
const char itemCoal = 1;   
const char itemSpace = 32; 

LiquidCrystal_I2C lcd(0x27, 16, 2); 

const int joyYPin = A0; 
const int gLedPin = 7;
const int rLedPin = 6;
const int buzzerPin = 8; 

// icons
byte giftIcon[] = { 0b00100, 0b01010, 0b11111, 0b01010, 0b01010, 0b11111, 0b00000, 0b00000 };
byte coalIcon[] = { 0b00000, 0b00100, 0b01110, 0b11111, 0b11111, 0b01110, 0b00100, 0b00000 };

long score = 0;
int elfLane = 0; 
char topLane[16] = "               "; 
char bottomLane[16] = "               "; 

// map pattern
const int patternLength = 15;
const char scrollPattern[patternLength] = {
  itemGift, itemSpace, itemCoal, itemSpace, itemGift, 
  itemGift, itemSpace, itemCoal, itemCoal, itemSpace, 
  itemSpace, itemGift, itemSpace, itemCoal, itemGift  
};
int patternIndex = 0; 

void setup() {
  pinMode(gLedPin, OUTPUT);
  pinMode(rLedPin, OUTPUT);
  pinMode(buzzerPin, OUTPUT);
  
  lcd.init();
  lcd.backlight();
  
  // create custom art
  lcd.createChar(itemGift, giftIcon); 
  lcd.createChar(itemCoal, coalIcon); 
  
  lcd.clear();
  lcd.print("Ready!");
  delay(1000);
}

void loop() {
  readJoystick();
  moveItems();
  drawScreen();
  delay(250); 
}

// check up or down
void readJoystick() {
  int val = analogRead(joyYPin);
  if (val < 300) elfLane = 0;
  else if (val > 700) elfLane = 1;
}

// play tones
void playSound(int hit) {
  if (hit == 1) { 
    tone(buzzerPin, 600, 50);
    delay(50);
    tone(buzzerPin, 800, 100);
  } else { 
    tone(buzzerPin, 150, 200);
  }
}

// adjust score and leds
void updateScore(int points) {
  if (points > 0) {
    score += points;
    digitalWrite(gLedPin, HIGH);
    playSound(1);
    digitalWrite(gLedPin, LOW);
  } else {
    score -= 5;
    if (score < 0) score = 0;
    digitalWrite(rLedPin, HIGH);
    playSound(-1);
    delay(100); 
    digitalWrite(rLedPin, LOW);
  }
}

// scroll logic and collision
void moveItems() {
  // check if elf hits front item
  if (topLane[0] == itemGift && elfLane == 0) updateScore(10);
  if (topLane[0] == itemCoal && elfLane == 0) updateScore(-5);
  if (bottomLane[0] == itemGift && elfLane == 1) updateScore(10);
  if (bottomLane[0] == itemCoal && elfLane == 1) updateScore(-5);

  // shift left
  for (int i = 0; i < 15; i++) {
    topLane[i] = topLane[i+1];
    bottomLane[i] = bottomLane[i+1];
  }

  // add new items from pattern
  topLane[15] = scrollPattern[patternIndex % patternLength];
  bottomLane[15] = scrollPattern[(patternIndex + 7) % patternLength];
  patternIndex++;
}

// display all
void drawScreen() {
  lcd.setCursor(0, 0);
  lcd.print(score);
  lcd.print(elfLane == 0 ? ">" : " ");
  for (int i = 0; i < 14; i++) {
    if (topLane[i] == itemSpace) lcd.print(" ");
    else lcd.write(topLane[i]);
  }

  lcd.setCursor(0, 1);
  lcd.print("      "); 
  lcd.setCursor(5, 1);
  lcd.print(elfLane == 1 ? ">" : " ");
  for (int i = 0; i < 10; i++) {
    if (bottomLane[i] == itemSpace) lcd.print(" ");
    else lcd.write(bottomLane[i]);
  }
}
